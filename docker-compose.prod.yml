services:
  typesense:
    image: typesense/typesense:26.0
    container_name: mattermost-typesense
    restart: ${RESTART_POLICY:-unless-stopped}
    command: '--data-dir /data --api-key=${TYPESENSE_API_KEY:-xyz} --enable-cors'
    volumes:
      - ${TYPESENSE_DATA_PATH:-./volumes/typesense/data}:/data:rw
    ports:
      - "8108:8108"
    networks:
      - mattermost
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8108/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mattermost:
    build:
      context: .
      dockerfile: Dockerfile.prebuilt
    container_name: mattermost-server
    restart: ${RESTART_POLICY:-unless-stopped}
    networks:
      - mattermost
    security_opt:
      - no-new-privileges:true
    pids_limit: 200
    tmpfs:
      - /tmp
    volumes:
      - ${MATTERMOST_CONFIG_PATH:-./volumes/app/mattermost/config}:/mattermost/config:rw
      - ${MATTERMOST_DATA_PATH:-./volumes/app/mattermost/data}:/mattermost/data:rw
      - ${MATTERMOST_LOGS_PATH:-./volumes/app/mattermost/logs}:/mattermost/logs:rw
      - ${MATTERMOST_PLUGINS_PATH:-./volumes/app/mattermost/plugins}:/mattermost/plugins:rw
      - ${MATTERMOST_CLIENT_PLUGINS_PATH:-./volumes/app/mattermost/client/plugins}:/mattermost/client/plugins:rw
      - ${MATTERMOST_BLEVE_INDEXES_PATH:-./volumes/app/mattermost/bleve-indexes}:/mattermost/bleve-indexes:rw
    environment:
      # Timezone
      - TZ=${TZ:-UTC}
      
      # Database settings (connects to host PostgreSQL via localhost)
      - MM_SQLSETTINGS_DRIVERNAME=${MM_SQLSETTINGS_DRIVERNAME:-postgres}
      - MM_SQLSETTINGS_DATASOURCE=${MM_SQLSETTINGS_DATASOURCE}
      
      # Site configuration
      - MM_SERVICESETTINGS_SITEURL=${MM_SERVICESETTINGS_SITEURL:-http://localhost:8065}
      - MM_SERVICESETTINGS_LISTENADDRESS=:8065
      - MM_SERVICESETTINGS_ENABLEDEVELOPER=${MM_ENABLE_DEVELOPER:-false}
      
      # File storage (local or S3)
      - MM_FILESETTINGS_DRIVERNAME=${MM_FILESETTINGS_DRIVERNAME:-local}
      - MM_FILESETTINGS_DIRECTORY=/mattermost/data
      - MM_FILESETTINGS_AMAZONS3ACCESSKEYID=${MM_FILESETTINGS_AMAZONS3ACCESSKEYID:-}
      - MM_FILESETTINGS_AMAZONS3SECRETACCESSKEY=${MM_FILESETTINGS_AMAZONS3SECRETACCESSKEY:-}
      - MM_FILESETTINGS_AMAZONS3BUCKET=${MM_FILESETTINGS_AMAZONS3BUCKET:-}
      - MM_FILESETTINGS_AMAZONS3PATHPREFIX=${MM_FILESETTINGS_AMAZONS3PATHPREFIX:-}
      - MM_FILESETTINGS_AMAZONS3REGION=${MM_FILESETTINGS_AMAZONS3REGION:-}
      - MM_FILESETTINGS_AMAZONS3ENDPOINT=${MM_FILESETTINGS_AMAZONS3ENDPOINT:-}
      - MM_FILESETTINGS_AMAZONS3SSL=${MM_FILESETTINGS_AMAZONS3SSL:-true}
      - MM_FILESETTINGS_MAXFILESIZE=${MM_FILESETTINGS_MAXFILESIZE:-52428800}
      
      # Plugin settings
      - MM_PLUGINSETTINGS_ENABLE=true
      - MM_PLUGINSETTINGS_ENABLEUPLOADS=true
      - MM_PLUGINSETTINGS_DIRECTORY=/mattermost/plugins
      - MM_PLUGINSETTINGS_CLIENTDIRECTORY=/mattermost/client/plugins
      
      # Email settings (configure for production)
      - MM_EMAILSETTINGS_ENABLESIGNUPWITHEMAIL=${MM_EMAIL_SIGNUP:-true}
      - MM_EMAILSETTINGS_ENABLESIGNINWITHEMAIL=${MM_EMAIL_SIGNIN:-true}
      - MM_EMAILSETTINGS_ENABLESIGNINWITHUSERNAME=${MM_USERNAME_SIGNIN:-true}
      - MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS=${MM_SEND_EMAIL:-false}
      - MM_EMAILSETTINGS_SMTPSERVER=${MM_SMTP_SERVER:-}
      - MM_EMAILSETTINGS_SMTPPORT=${MM_SMTP_PORT:-587}
      - MM_EMAILSETTINGS_SMTPUSERNAME=${MM_SMTP_USERNAME:-}
      - MM_EMAILSETTINGS_SMTPPASSWORD=${MM_SMTP_PASSWORD:-}
      - MM_EMAILSETTINGS_FEEDBACKEMAIL=${MM_FEEDBACK_EMAIL:-}
      - MM_EMAILSETTINGS_REPLYTOADDRESS=${MM_REPLYTO_EMAIL:-}
      
      # Security settings
      - MM_SERVICESETTINGS_ENABLEMULTIFACTORAUTHENTICATION=${MM_ENABLE_MFA:-false}
      
      # API Settings
      - MM_SERVICESETTINGS_ENABLEAPICHANNELDELETION=${MM_SERVICESETTINGS_ENABLEAPICHANNELDELETION:-false}
      - MM_SERVICESETTINGS_ENABLEAPITEAMDELETION=${MM_SERVICESETTINGS_ENABLEAPITEAMDELETION:-false}
      - MM_SERVICESETTINGS_ENABLEAPITRIGGERADMINNOTIFICATIONS=${MM_SERVICESETTINGS_ENABLEAPITRIGGERADMINNOTIFICATIONS:-false}
      - MM_SERVICESETTINGS_ENABLEAPIUSERDELETION=${MM_SERVICESETTINGS_ENABLEAPIUSERDELETION:-false}
      - MM_SERVICESETTINGS_ENABLEAPIPOSTDELETION=${MM_SERVICESETTINGS_ENABLEAPIPOSTDELETION:-false}
      - MM_SERVICESETTINGS_ALLOWCOOKIESFORSUBDOMAINS=${MM_SERVICESETTINGS_ALLOWCOOKIESFORSUBDOMAINS:-false}
      
      # Performance settings
      - MM_SQLSETTINGS_MAXIDLECONNS=20
      - MM_SQLSETTINGS_MAXOPENCONNS=300
      - MM_SERVICESETTINGS_GOROUTINEHEALTHTHRESHOLD=-1
      
      # Bleve search
      - MM_BLEVESETTINGS_INDEXDIR=${MM_BLEVESETTINGS_INDEXDIR:-/mattermost/bleve-indexes}
      
      # Typesense search
      - MM_TYPESENSESETTINGS_CONNECTIONURL=${MM_TYPESENSESETTINGS_CONNECTIONURL:-http://typesense:8108}
      - MM_TYPESENSESETTINGS_APIKEY=${MM_TYPESENSESETTINGS_APIKEY:-xyz}
      - MM_TYPESENSESETTINGS_ENABLEINDEXING=${MM_TYPESENSESETTINGS_ENABLEINDEXING:-false}
      - MM_TYPESENSESETTINGS_ENABLESEARCHING=${MM_TYPESENSESETTINGS_ENABLESEARCHING:-false}
      - MM_TYPESENSESETTINGS_ENABLEAUTOCOMPLETE=${MM_TYPESENSESETTINGS_ENABLEAUTOCOMPLETE:-false}
      
      # Logging
      - MM_LOGSETTINGS_CONSOLELEVEL=${MM_LOGSETTINGS_CONSOLELEVEL:-INFO}
      - MM_LOGSETTINGS_ENABLECONSOLE=${MM_LOGSETTINGS_ENABLECONSOLE:-true}
      - MM_LOGSETTINGS_ENABLEFILE=${MM_LOGSETTINGS_ENABLEFILE:-true}
    ports:
      - "8065:8065"
    depends_on:
      typesense:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8065/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

volumes:
  mattermost_config:
    driver: local
  mattermost_data:
    driver: local
  mattermost_logs:
    driver: local
  mattermost_plugins:
    driver: local
  mattermost_client_plugins:
    driver: local
  mattermost_bleve_indexes:
    driver: local
  typesense_data:
    driver: local

networks:
  mattermost:
    driver: bridge
    name: mattermost-network
