# Uppy Companion — Nginx reverse-proxy snippet
#
# Add this `location` block inside the server block that serves Mattermost.
# Companion itself runs on port 3020 (see docker-compose.yml).
#
# With this configuration:
#   https://YOUR_DOMAIN/api/companion/  →  http://companion:3020/

location /api/companion/ {
    # Route to the Companion container.
    proxy_pass http://companion:3020/;

    # Standard proxy headers.
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Companion streams large files; disable request/response buffering.
    proxy_request_buffering off;
    proxy_buffering off;

    # Allow long-running uploads.
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    # Strip the /api/companion prefix before forwarding.
    rewrite ^/api/companion/(.*) /$1 break;
}
